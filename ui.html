<!DOCTYPE html>
<html>

<head>
  <title>Write User Stories - PoC</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body id="app" class="p-4">
  <div>
    <label for="comment" class="block text-sm font-medium leading-6 text-gray-900">
      Additional Context
    </label>
    <div class="mt-2">
      <textarea v-model="message" rows="4" name="comment" id="comment"
        class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">

      </textarea>
    </div>
  </div>
  <img id="thumbnail" class="w-full">

  <button @click="askChatGPT" type="button"
    class="w-full mb-4 rounded-full bg-indigo-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
    Generate User Story
  </button>

  <div id="content" v-if="isVisibleResponse">
    {{ response }}
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
    const { createApp, ref } = Vue

    createApp({
      data() {
        return {
          message: 'Hello!',
          isVisibleResponse: false,
          response: undefined,
        }
      },
      methods: {
        async askChatGPT() {
          
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer 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'
            },
            body: JSON.stringify({
              'model': 'gpt-3.5-turbo',
              'messages': [
                {
                  'role': 'system',
                  'content': 'You are a helpful assistant.'
                },
                {
                  'role': 'user',
                  'content': this.message
                }
              ]
            })
          });

          const data = await response.json();

          this.response = data.choices[0].message.content
          this.isVisibleResponse = true
        }
      }
    }).mount('#app')
  </script>

  <script>

    window.onmessage = async (event) => {

      if (event.data.pluginMessage.type === 'convert-image') {
        const base64Image = btoa(String.fromCharCode(...new Uint8Array(event.data.pluginMessage.exportedFrame)));

        currentDataUrl = `data:image/jpeg;base64,${base64Image}`;
        document.getElementById('thumbnail').src = currentDataUrl;
      }
    };

  </script>
</body>

</html>